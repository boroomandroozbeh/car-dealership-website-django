{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% block content %}
    <section class="section">
        <div class="container">
            <!-- هدر صفحه -->
            <header class="page-header">
                <div class="page-header-main">
                    {% if current_tag %}
                        <h1 class="page-header-title">خودروهای دارای تگ «{{ current_tag.title }}»</h1>
                        <p class="page-header-subtitle">
                            لیست خودروهایی که با برچسب «{{ current_tag.title }}» در نمایشگاه دنیا خودرو ثبت شده‌اند.
                            می‌توانید با استفاده از فیلترها، انتخاب خود را دقیق‌تر کنید.
                        </p>
                    {% else %}
                        <h1 class="page-header-title">خرید خودرو در دنیا خودرو</h1>
                        <p class="page-header-subtitle">
                            لیست به‌روز خودروهای صفر و کارکرده در نمایشگاه دنیا خودرو. با استفاده از فیلترها می‌توانید
                            بر اساس بودجه، برند، مدل، سال ساخت و کارکرد، خودروی مناسب خود را پیدا کنید.
                        </p>
                    {% endif %}
                </div>
                <div class="results-meta">
                    <span>تعداد نتایج: {{ page_obj.paginator.count }} خودروی موجود</span>
                    {% if current_tag %}
                        <span class="results-filter">نتایج بر اساس تگ: {{ current_tag.name }}</span>
                    {% else %}
                        <span class="results-filter">صفحه {{ page_obj.number }} از {{ page_obj.paginator.num_pages }}</span>
                    {% endif %}
                </div>
            </header>
            <!-- فیلترها -->
            <form class="filters" method="get">
                <!-- جستجو -->
                <input type="text"
                       name="q"
                       value="{{ request.GET.q }}"
                       class="input"
                       placeholder="جستجو بر اساس برند، مدل یا عبارت‌هایی مثل «شاسی‌بلند»...">
                <!-- برند -->
                <select class="input" name="brand">
                    <option value="">همه برندها</option>
                    {% for brand in brands %}
                        <option value="{{ brand.id }}"
                                {% if request.GET.brand == brand.id|stringformat:"s" %}selected{% endif %}>
                            {{ brand.name }}
                        </option>
                    {% endfor %}
                </select>
                <!-- از سال -->
                <select class="input" name="year_min">
                    <option value="">از سال</option>
                    {% for y in years %}
                        <option value="{{ y }}" {% if request.GET.year_min == y %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
                <!-- تا سال -->
                <select class="input" name="year_max">
                    <option value="">تا سال</option>
                    {% for y in years %}
                        <option value="{{ y }}" {% if request.GET.year_max == y %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
                <!-- قیمت -->
                <select class="input" name="price_max">
                    <option value="">حداکثر قیمت</option>
                    <option value="500000000"
                            {% if request.GET.price_max == "500000000" %}selected{% endif %}>۵۰۰ میلیون</option>
                    <option value="1000000000"
                            {% if request.GET.price_max == "1000000000" %}selected{% endif %}>۱ میلیارد</option>
                    <option value="1500000000"
                            {% if request.GET.price_max == "1500000000" %}selected{% endif %}>۱.۵ میلیارد</option>
                    <option value="2000000000"
                            {% if request.GET.price_max == "2000000000" %}selected{% endif %}>۲ میلیارد</option>
                </select>
                <!-- نوع گیربکس -->
                <select class="input" name="gear">
                    <option value="">نوع گیربکس</option>
                    <option value="manual"
                            {% if request.GET.gear == "manual" %}selected{% endif %}>دنده‌ای</option>
                    <option value="auto" {% if request.GET.gear == "auto" %}selected{% endif %}>اتومات</option>
                </select>
                <!-- مرتب‌سازی -->
                <select class="input" name="sort">
                    <option value="">مرتب‌سازی</option>
                    <option value="new" {% if request.GET.sort == "new" %}selected{% endif %}>جدیدترین</option>
                    <option value="cheap" {% if request.GET.sort == "cheap" %}selected{% endif %}>ارزان‌ترین</option>
                    <option value="expensive"
                            {% if request.GET.sort == "expensive" %}selected{% endif %}>گران‌ترین</option>
                    <option value="low_mileage"
                            {% if request.GET.sort == "low_mileage" %}selected{% endif %}>کم‌کارکردترین</option>
                </select>
                <button type="submit" class="btn btn-secondary">اعمال فیلتر</button>
            </form>
            <!-- گرید خودروها -->
            <div class="grid-cars">
                {% for car in cars %}
                    <article class="car-card">
                        {% if car.main_image %}
                            <img src="{{ car.main_image.url }}"
                                 alt="{{ car.title }}"
                                 class="car-image" />
                        {% else %}
                            <img src="" alt="{{ car.title }}" class="car-image" />
                        {% endif %}
                        <div class="car-body">
                            <h3 class="car-title">{{ car.title }}</h3>
                            <p class="car-meta">
                                کارکرد: {{ car.mileage|intcomma }} کیلومتر ·
                                {{ car.get_gear_type_display }}
                                {% if car.body_status %}· {{ car.body_status }}{% endif %}
                            </p>
                            <p class="car-price">
                                {% if car.price %}
                                    {{ car.price|intcomma }} تومان
                                {% else %}
                                    قیمت توافقی
                                {% endif %}
                            </p>
                            <div class="car-footer">
                                <span class="car-city">{{ car.city }}</span>
                                <a href="{% url 'car_detail' car.slug %}" class="btn btn-small">مشاهده جزئیات</a>
                            </div>
                        </div>
                    </article>
                {% endfor %}
            </div>
            <!-- صفحه‌بندی -->
            <nav class="pagination">
                {# بعدی #}
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="page-link">بعدی</a>
                {% else %}
                    <span class="page-link is-disabled">بعدی</span>
                {% endif %}
                {# شماره صفحات + … #}
                <div class="page-numbers">
                    {% for num in page_range %}
                        {% if num == page_obj.paginator.ELLIPSIS %}
                            <span class="page-ellipsis">…</span>
                        {% elif num == page_obj.number %}
                            <span class="page-number is-active">{{ num }}</span>
                        {% else %}
                            <a href="?page={{ num }}" class="page-number">{{ num }}</a>
                        {% endif %}
                    {% endfor %}
                </div>
                {# قبلی #}
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}"
                       class="page-link">قبلی</a>
                {% else %}
                    <span class="page-link is-disabled">قبلی</span>
                {% endif %}
            </nav>
        </div>
    </section>
{% endblock %}
